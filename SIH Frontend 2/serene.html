<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Serene.ai - Chat with AI</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    /* fallback styles if style.css misses these */
    .chat-container {max-width: 720px; margin: 2rem auto; border: 1px solid #eee; border-radius: 12px; overflow: hidden; background:#fff;}
    .chat-header {padding: 14px 16px; font-weight: 700; background: #8d99f3; border-bottom: 1px solid #eee;}
    .chat-box {height: 60vh; overflow-y: auto; padding: 16px; background:#fff;}
    .chat-input {display: flex; gap: 8px; padding: 12px; border-top: 1px solid #eee; background:#f8fafc;}
    .chat-input input {flex: 1; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px;}
    .btn {padding: 10px 14px; background:#0ea5e9; color:#fff; border-radius: 8px; border:0; cursor:pointer;}
    .btn:disabled {opacity: .6; cursor: not-allowed;}
    .message {margin-bottom: 14px;}
    .message .role {font-weight: 600; margin-bottom: 4px;}
    .user-message {background:#ecfeff; border:1px solid #cffafe; padding:10px 12px; border-radius:10px;}
    .ai-message {background:#f9fafb; border:1px solid #e5e7eb; padding:10px 12px; border-radius:10px;}
    .typing {opacity: .7; font-style: italic;}
    .crisis {color: #b91c1c; font-weight: 700;}
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">Talk to Serene.ai</div>

    <div class="chat-box" id="chat-log"></div>

    <div class="chat-input">
      <input type="text" id="chat-input" placeholder="Type your message..." autocomplete="off"/>
      <button id="chat-send" class="btn">Send</button>
    </div>
  </div>

  <script>
    // Update this when you deploy the backend
    const API_BASE = "http://127.0.0.1:8000/v1";

    (function () {
      const log    = document.getElementById("chat-log");
      const input  = document.getElementById("chat-input");
      const sendBtn= document.getElementById("chat-send");

      let typingNode = null;     // "Serene is typingâ€¦" handle
      let sending = false;        // simple in-flight guard

      function add(role, text, opts = {}) {
        const wrap = document.createElement("div");
        wrap.className = `message ${role === "You" ? "user-message" : "ai-message"}`;
        if (opts.typing) wrap.classList.add("typing");
        if (opts.crisis) wrap.classList.add("crisis");

        const roleDiv = document.createElement("div");
        roleDiv.className = "role";
        roleDiv.style.color = role === "You" ? "#0f766e" : "#111827";
        roleDiv.textContent = role;

        const textDiv = document.createElement("div");
        textDiv.style.whiteSpace = "pre-wrap";
        textDiv.textContent = text;

        wrap.appendChild(roleDiv);
        wrap.appendChild(textDiv);
        log.appendChild(wrap);
        log.scrollTop = log.scrollHeight;
        return wrap;
      }

      function showTyping() {
        removeTyping();
        typingNode = add("Serene", "Serene is typingâ€¦", { typing: true });
      }
      function removeTyping() {
        if (typingNode && typingNode.parentNode) typingNode.parentNode.removeChild(typingNode);
        typingNode = null;
      }

      async function sendMsg() {
        if (sending) return; // avoid double sends
        const text = (input.value || "").trim();
        if (!text) return;

        add("You", text);
        input.value = "";
        input.focus();

        // UI lock + typing indicator
        sending = true;
        sendBtn.disabled = true;
        showTyping();

        // Abort if server hangs too long
        const ctrl = new AbortController();
        const timeout = setTimeout(() => ctrl.abort(), 30000); // 30s

        try {
          const res = await fetch(`${API_BASE}/serene-chat`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text }),
            signal: ctrl.signal
          });

          let data;
          try { data = await res.json(); } catch { data = {}; }

          if (!res.ok) {
            const detail = data && (data.detail || data.message);
            throw new Error(detail || res.statusText || "Server error");
          }

          removeTyping();
          add("Serene", data.reply || "I'm here with you.");

          if (data.crisis) {
            add("Serene",
              "If you feel unsafe: please reach out to a local helpline or emergency number. ðŸ’™",
              { crisis: true }
            );
          }
        } catch (e) {
          removeTyping();
          add("Serene",
            "I couldn't reach the server right now. Would you like to try a short grounding exercise while we reconnect?"
          );
          console.warn(e);
        } finally {
          clearTimeout(timeout);
          sending = false;
          sendBtn.disabled = false;
        }
      }

      // Wire up UI events
      sendBtn.addEventListener("click", sendMsg);
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendMsg();
      });

      // Optional: quick backend health check on load (uncomment to use)
      // (async () => {
      //   try {
      //     const r = await fetch(`${API_BASE}/health`, { cache: "no-store" });
      //     if (!r.ok) throw new Error("Backend not healthy");
      //   } catch (e) {
      //     add("Serene", "Please start the backend server before we chat (server_serene.py).");
      //   }
      // })();

      // Warm welcome
      add("Serene", "Hi! Iâ€™m here for you. What would you like to talk about today?");
    })();
  </script>
  <style>
  /* --- force the input to actually show up --- */
  .chat-input{ 
    display:flex; 
    align-items:center; 
    gap:12px; 
    padding:14px; 
    background:#f8fafc;
    border-top:1px solid #eee;
    position:relative;
    z-index:1;
  }
  /* some themes add a gradient overlay via ::before â€” kill it */
  .chat-input::before{ display:none !important; }

  #chat-input{
    flex:1;
    min-height:44px;
    padding:10px 14px;
    border:1px solid #d1d5db !important;
    border-radius:12px !important;
    background:#ffffff !important;
    color:#111827 !important;
    opacity:1 !important;
    box-shadow: inset 0 1px 2px rgba(0,0,0,.04);
    position:relative; 
    z-index:2;
  }
  #chat-input::placeholder{ color:#9ca3af; }
  #chat-input:focus{
    outline:none;
    border-color:#93c5fd;
    box-shadow:0 0 0 3px rgba(59,130,246,.15);
  }

  #chat-send{
    min-width:120px;
    border-radius:24px;
  }
</style>
<style>
  /* Force a simple 2-column layout: [ input | Send ] */
  .chat-input{
    display: grid !important;
    grid-template-columns: 1fr 140px !important;
    align-items: center !important;
    gap: 12px !important;
    padding: 14px !important;
    background: #f8fafc !important;
    border-top: 1px solid #eee !important;
    position: relative !important;
    z-index: 2 !important;
  }

  /* Some themes draw decorative overlays in the footerâ€”turn them off */
  .chat-input::before,
  .chat-input::after,
  .chat-container::after { display: none !important; content: none !important; }

  /* Make the input actually fill the left column */
  #chat-input,
  .chat-input input#chat-input{
    width: 100% !important;
    min-width: 0 !important;      /* fixes "flex-shrink to zero" cases */
    flex: 1 1 auto !important;
    height: 46px !important;
    padding: 10px 14px !important;
    border: 1px solid #d1d5db !important;
    border-radius: 12px !important;
    background: #ffffff !important;
    color: #111827 !important;
    opacity: 1 !important;
    box-shadow: inset 0 1px 2px rgba(0,0,0,.04) !important;
    position: relative !important;
    z-index: 3 !important;
  }
  #chat-input::placeholder{ color:#9ca3af !important; }
  #chat-input:focus{
    outline: none !important;
    border-color: #93c5fd !important;
    box-shadow: 0 0 0 3px rgba(59,130,246,.15) !important;
  }

  /* Button on the right */
  #chat-send{
    height: 46px !important;
    min-width: 120px !important;
    border-radius: 9999px !important;
  }
</style>

</body>
</html>
